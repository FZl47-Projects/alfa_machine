{% extends 'base/base_template.html' %}
{% load static %}

{% block Title %}
    استعلامات
{% endblock %}

{% block Link %}
    <link rel="stylesheet" href="{% static 'frontend/styles/query-list.css' %}">
{% endblock %}

{% block Style %}
    <style>
        .table tbody tr td {
            padding: 0.75rem 0.5rem !important;
        }
    </style>
{% endblock %}

{% block Content %}
    <!-- morde-descriptin popup -->
    {% for inquiry in inquiries %}
        <!-- Edit inquiry modal -->
        {% include 'public/inquiry/components/edit_inquiry.html' %}
        <!-- .End Edit inquiry modal -->

        <!-- Upload inquiry file -->
        {% include 'public/inquiry/components/add_inquiry_file.html' %}
        <!-- .End Upload inquiry file -->

        <div class="content-modal-two modal-Reason-rejection">
            <div class="inner-modal">
                <form class="p-4">
                    <div class="information-section">
                        <div class="information-item">
                            <label for="descriptionInput">دلیل رد شدن</label>
                            <textarea name="" id="descriptionInput" cols="30" rows="10" disabled>{{ inquiry.status.description }}</textarea>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="content-modal-two modal-Followed-up">
            <div class="inner-modal">
                <form class="p-4">
                    <div class="information-section">
                        <div class="information-item">
                            توضیح :
                        </div>
                        <div class="information-item">
                            {{ inquiry.status.description }}
                        </div>
                    </div>
                    <div class="information-section">
                        <div class="information-item">
                            فایل :
                        </div>
                        <div class="information-item">
                            {% if inquiry.status.get_file_url %}
                                <a class="btn btn-success mx-auto col-12 d-block"
                                   href="{{ inquiry.status.get_file_url }}" download="">دانلود</a>
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal" id="inquiryDescription-{{ inquiry.id }}" tabindex="-1" role="dialog" aria-labelledby="inquiryDescription" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ inquiry.title }}</h5>
                    </div>
                    <div class="modal-body">
                        <div class="hhh">
                            <div class="mt-2">
                                {{ inquiry.description }}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-modal-two modal-files">
            <div class="inner-modal">
                <form class="p-4">
                    <div class="close-modal close-modal-description">
                        <i class="fa fa-close fa-xl text-danger"
                           onclick="this.parentElement.parentElement.parentElement.parentElement.classList.remove('active')"></i>
                    </div>
                    <div class="text-center my-2">
                        <h4>فایل ها</h4>
                    </div>
                    <div class="hhh">
                        <table class="table">
                            <tr>
                                <th>تاریخ</th>
                                <th>واحد</th>
                                <th>نام فایل</th>
                                <th>توضیحات</th>
                                <th>فایل</th>
                            </tr>
                            {% for file in inquiry.get_files %}
                                <tr>
                                    <td class="font-80 datetime-convert">
                                        {{ file.get_created_at }}
                                    </td>
                                    <td class="font-80">
                                        {{ file.from_department.name }}
                                    </td>
                                    <td class="font-80">
                                        {{ file.name }}
                                    </td>
                                    <td class="font-70">
                                        {{ file.description }}
                                    </td>
                                    <td>
                                        <a href="{{ file.get_file_url }}" class="text-primary">دانلود</a>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr class="container-not-found-base">
                                    <td colspan="1000">چیزی ثبت نشده است</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete inquiry modal -->
        <div class="modal fade" id="deleteInquiryModal-{{ inquiry.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteInquiry" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">حذف استعلام</h5>
                    </div>
                    <form action="{% url 'public:inquiry_detail' inquiry_id=inquiry.id %}" method="post">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div>
                                <input type="hidden" name="type_request" value="delete">
                                <span>آیا از حذف <span class="fw-bold">'{{ inquiry.title }}'</span> مطمئن هستید؟</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-danger">بله</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- .End Delete inquiry modal -->
    {% endfor %}

    <div>
        <div class="text-center d-flex justify-content-center mt-1 px-3">
            <h3 class="title-page w-100 me-5">لیست استعلامات</h3>
            <div class="mt-2">
                <a href="{{ user.get_absolute_url_dashboard }}" class="btn btn-danger">بازگشت</a>
            </div>
        </div>

        <div class="col-12 col-md-5 col-lg-6 mx-auto mb-4 p-4">
            <div>
                <form action="{% url 'public:inquiry_owner' %}" method="get" class="overflow-hidden d-flex align-items-center">
                    <input type="hidden" name="sort_by" value="{{ request.GET.sort_by }}">
                    <div class="cnt-search col-10 col-md-7">
                        <input type="text" id="q" name="search" value="{{ request.GET.search }}"
                               placeholder="عنوان، شماره استعلام و ...">
                        <div>
                            <button><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="filters-radio d-flex justify-content-start align-items-center mt-4">
                <div class="title text-right">
                    مرتب بر اساس :
                </div>
                <div class="d-flex justify-content-center col-8 me-3 gap-2">
                    <div>
                        <a class="{% if request.GET.sort_by == 'latest' or not request.GET.sort_by %}active{% endif %}"
                           href="{% url 'public:inquiry_owner' %}?sort_by=latest">
                            جدید ترین
                        </a>
                    </div>
                    <div>
                        <a class="{% if request.GET.sort_by == 'oldest' %}active{% endif %}"
                           href="{% url 'public:inquiry_owner' %}?sort_by=oldest">
                            قدیمی ترین
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <main class="main content-page container" style="max-width: none;">
        <section class="col-12 project-content">
            <div class="inner-project">
                <!-- Start Inquiry list table -->
                <div class="table-responsive">
                    <table class="table table-bordered rounded-3 overflow-hidden">
                        <!-- Table header -->
                        <thead class="table-dark">
                            <tr class="text-center text-nowrap">
                                <th>ردیف</th>
                                <th>واحد استعلام گیرنده</th>
                                <th>کارفرما</th>
                                <th>شماره استعلام</th>
                                <th>تاریخ دریافت</th>
                                <th>تاریخ ارسال</th>
                                <th>مهلت پاسخ</th>
                                <th>عنوان</th>
                                <th>توضیحات</th>
                                <th>وضعیت بررسی</th>
                                <th>وضعیت</th>
                                <th>فایل</th>
                                <th>پروژه</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <!-- Table body -->
                        <tbody>
                            {% for inquiry in inquiries %}
                                <tr class="text-center">
                                    <td>
                                        {{ forloop.counter }}
                                    </td>
                                    <td>
                                        {{ inquiry.from_department.name }}
                                    </td>
                                    <td class="text-nowrap">
                                        {{ inquiry.sender|truncatechars:16 }}
                                    </td>
                                    <td>
                                        {{ inquiry.number_id }}
                                    </td>
                                    <td class="datetime-convert">
                                        {{ inquiry.time_receive }}
                                    </td>
                                    <td class="datetime-convert">
                                        {{ inquiry.time_submit }}
                                    </td>
                                    <td class="datetime-convert">
                                        {{ inquiry.time_deadline_response }}
                                    </td>
                                    <td>
                                        {{ inquiry.title|truncatechars:16 }}
                                    </td>
                                    <td data-bs-toggle="modal" data-bs-target="#inquiryDescription-{{ inquiry.id }}">
                                        <i class="fa fa-eye fw-bold btn btn-info btn-sm" title="مشاهده"></i>
                                    </td>
                                    <td>
                                        {% if inquiry.get_status == 'accepted' %}
                                            <span class="text-success">تایید شده</span>
                                        {% elif inquiry.get_status == 'rejected' %}
                                            <span class="text-danger">رد شده</span>
                                        {% elif inquiry.get_status == 'progress' %}
                                            <span class="text-primary">درحال بررسی</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-nowrap">
                                        {{ inquiry.get_state_display }}
                                    </td>
                                    <td>
                                        <div class="d-flex flex-wrap justify-content-center align-items-center gap-1">
                                            <span class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addInquiryFileModal-{{ inquiry.id }}">
                                                آپلود
                                            </span>
                                            <span class="tarif-task btn-create-report btn btn-sm btn-outline-secondary btn-files-query">
                                                نمایش
                                            </span>
                                        </div>
                                    </td>
                                    <td class="text-nowrap">
                                        {% if not inquiry.project %}
                                            <a href="{% url 'public:project_add' %}?inquiry-id={{ inquiry.id }}"
                                               class="btn btn-sm btn-outline-success">تبدیل به پروژه</a>
                                        {% else %}
                                            <a href="{{ inquiry.project.get_absolute_url }}">{{ inquiry.project.name|truncatechars:10 }}</a>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-nowrap">
                                            <i class="fa fa-edit btn btn-sm btn-warning fw-bold"
                                               data-bs-toggle="modal" data-bs-target="#editInquiryModal-{{ inquiry.id }}" title="ویرایش"></i>
                                            <i class="fa-solid fa-trash-can btn btn-sm btn-danger"
                                               data-bs-toggle="modal" data-bs-target="#deleteInquiryModal-{{ inquiry.id }}" title="حذف"></i>
                                        </div>
                                    </td>
                                </tr>
                            {% empty %}
                                <div class="container-not-found-base">
                                    <p>چیزی یافت نشد</p>
                                </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- .End Inquiry list table -->
            </div>
        </section>
    </main>

{% endblock %}

{% block Script %}
    <script type="module" src="{% static 'frontend/js/query-list.js' %}"></script>
{% endblock %}